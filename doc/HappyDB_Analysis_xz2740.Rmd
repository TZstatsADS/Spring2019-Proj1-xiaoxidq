---
title: "PJ1_HappyDB"
author: "Xiaoxi Zhao"
date: "2/2/2019"
output:
  rmarkdown::html_document:
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load library, include=FALSE}
#load the required packages
library(tm)
library(tidytext)
library(tidyverse)
library(DT)
library(vcd)
library(shiny)
library(ngram)
library(RColorBrewer)
library(gridGraphics)
library(gridExtra)
library(wordcloud)
library(sentimentr)
library(qdap)
library(syuzhet)
library(d3heatmap)
```

```{r read data, warning=FALSE, message=FALSE,echo=FALSE}

urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/demographic.csv'
demo_data <- read_csv(urlfile)
hm_data<-read_csv("../output/processed_moments.csv")
sentence.data<-read.csv("../output/sentence.csv",as.is=T)

#combine demographic.cvs and the cleaned data
sel_data <- hm_data %>%
  inner_join(demo_data, by = "wid") %>%
  select(wid,
         original_hm,
         gender, 
         marital, 
         parenthood,
         reflection_period,
         age, 
         country, 
         predicted_category, 
         text) %>%
  mutate(count = sapply(hm_data$text, wordcount)) 
```

As we would like to identify interesting words for each inaugural speech, we use [TF-IDF](https://en.wikipedia.org/wiki/Tf%E2%80%93idf) to weigh each term within each speech. It highlights terms that are more specific for a particular speech. 

```{r echo=F}
corpus <- VCorpus(VectorSource(hm_data$text))
happy_dtm_tfidf <- DocumentTermMatrix(corpus, control = list(weighting = function(x) weightTfIdf(x,normalize =FALSE), stopwords = TRUE))
happy_dtm_tfidf = removeSparseTerms(happy_dtm_tfidf, 0.99)
freq = data.frame(sort(colSums(as.matrix(happy_dtm_tfidf)), decreasing=TRUE))
```

```{r fig.align="center",fig.height=5,fig.width=5,echo=FALSE}
wordcloud(rownames(freq), freq[,1], max.words=90,min.freq = 3, rot.per=0.3,random.order=FALSE,scale=c(4,0.2),use.r.layout=T,colors=brewer.pal(8,"Set1"))
```
```{r echo=F,fig.height=6.5,fig.width=12,echo=FALSE}
par(mfrow=c(1,2))
#wordcloud of 24hours reaction
corpus <- VCorpus(VectorSource(hm_data[hm_data$reflection_period=="24h",]$text))
happy_dtm_tfidf <- DocumentTermMatrix(corpus, control = list(weighting = function(x) weightTfIdf(x,normalize =FALSE), stopwords = TRUE))
happy_dtm_tfidf = removeSparseTerms(happy_dtm_tfidf, 0.99)
freq = data.frame(sort(colSums(as.matrix(happy_dtm_tfidf)), decreasing=TRUE))
wordcloud(rownames(freq), freq[,1], max.words=70,min.freq = 3, rot.per=0.3,random.order=FALSE,scale=c(4,0.2),use.r.layout=T,colors=brewer.pal(8,"Set1"))
#wordcloud of 3months reaction
corpus <- VCorpus(VectorSource(hm_data[hm_data$reflection_period=="3m",]$text))
happy_dtm_tfidf <- DocumentTermMatrix(corpus, control = list(weighting = function(x) weightTfIdf(x,normalize =FALSE), stopwords = TRUE))
happy_dtm_tfidf = removeSparseTerms(happy_dtm_tfidf, 0.99)
freq = data.frame(sort(colSums(as.matrix(happy_dtm_tfidf)), decreasing=TRUE))
wordcloud(rownames(freq), freq[,1], max.words=70,min.freq = 3, rot.per=0.3,random.order=FALSE,scale=c(4,0.2),use.r.layout=T,colors=brewer.pal(8,"Set1"))
```

```{r pie plot,echo=FALSE,warning=FALSE,fig.align="center"}
par(mfrow=c(1,1))
t<-sort(table(sel_data$predicted_category))
type<-names(t)
nums<-unname(t)
df<-data.frame(type,nums)
df<-df%>%
  select(type,nums=Freq)
col.use=brewer.pal(7, "Set2")
label_value <- paste('(', round(t/sum(t) * 100, 1), '%)', sep = '')
label <- paste(df$type, label_value, sep = '')
ggplot(data=df,mapping=aes(x="Content",y=nums,fill=label))+
  geom_bar(stat="identity",position="stack")+
  coord_polar(theta="y")+
  scale_fill_manual(values=col.use)+
  labs(x = '', y = '', title = '')+
  theme(axis.text = element_blank())
```

```{r splitage,echo=FALSE,warning=FALSE}
group<-c(1,seq(17,87,by=10),98)
agenum<-as.numeric(sel_data$age)
age_data<-sel_data[!is.na(agenum),]
age_data$age<-as.numeric(age_data$age)
age_data<-age_data%>%
  select(age,predicted_category)%>%
  filter(age<100)%>%
  mutate(agegroup=cut(age,breaks=group,labels=c("2-4","17-27","27-37","37-47","47-57","57-67","67-77","77-87","87-98")))%>%
  count(agegroup,predicted_category)%>%
  spread(predicted_category,n)
```

```{r stackplot,echo=FALSE,fig.align="center"}
age_data[is.na(age_data)]<-0
age_data<-gather(age_data,attribute,value,-agegroup)
age_data<-as.data.frame(age_data)
age_data2 <- data.frame(category = as.numeric(as.factor(age_data$attribute)),
                          freq = age_data$value,
                          age = age_data$agegroup)
ggplot(age_data2, aes(x=category, y=freq, fill=age)) + 
    geom_area() +
  scale_x_continuous(breaks=seq(1, 7, 1),
        labels=names(table(age_data$attribute)))
```


```{r mosaic plot,echo=FALSE,warning=FALSE,fig.align="center"}

mosaic(~predicted_category+marital,data=sel_data,highlighting="marital",,highlighting_fill=c("brown","pink","brown3","lightblue","coral4"),labeling= labeling_border(varnames=c(F,F),rot_labels = c(90,0,90,0), just_labels = c("left", "right", "right", "right")),margins=unit(4.7,"lines"))

```

```{r,include=FALSE,warning=F}
mosaic(~predicted_category+gender,data=sel_data,highlighting="gender",,highlighting_fill=c("pink","lightblue","black"),labeling= labeling_border(labels=c(F,T),varnames=c(F,T),rot_labels = c(0,90,90,0), just_labels = c("left", "right", "right", "right")),margins=unit(3,"lines"))
m<-grid.grab()
mosaic(~predicted_category+parenthood,data=sel_data,highlighting="parenthood",,highlighting_fill=c("pink","lightblue"),labeling= labeling_border(varnames=c(F,T),rot_labels = c(0,90,90,0), just_labels = c("left", "right", "right", "right")),margins=unit(3,"lines"))
a<-grid.grab()
```

```{r,echo=FALSE,warning=F,fig.height=4,fig.width=10}
grid.arrange(m,a,ncol=2)
```

##Sentiment Analysis

```{r echo=F,fig.align="center",fig.height=20}
## Summary emotions
happy.summary=tbl_df(sentence.data)%>%
  group_by(country)%>%
  summarise(
    anger=mean(anger,na.rm=TRUE),
    anticipation=mean(anticipation,na.rm=TRUE),
    disgust=mean(disgust,na.rm=TRUE),
    fear=mean(fear,na.rm=TRUE),
    joy=mean(joy,na.rm=TRUE),
    sadness=mean(sadness,na.rm=TRUE),
    surprise=mean(surprise,na.rm=TRUE),
    trust=mean(trust,na.rm=TRUE),
    negative=mean(negative,na.rm=TRUE),
    positive=mean(positive,na.rm=TRUE)
  )
happy.summary<-happy.summary[happy.summary$country!="NA",]
countryname<-happy.summary$country
happy.summary<-data.matrix(happy.summary[,-1])
rownames(happy.summary)<-as.data.frame(countryname)[,1]
library(shiny)
div(d3heatmap(happy.summary, scale="none", colors= "Reds",
          xaxis_font_size = 8,Rowv = FALSE,Colv=FALSE,show_grid=TRUE,yaxis_font_size = 4 ),
    align='center')
```


